{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold text-danger mb-0">Panneau Admin</h2>
  <a href="/" class="btn btn-outline-secondary btn-sm">Retour dashboard</a>
</div>

<div class="app-card p-3 mb-4">
  <h5 class="mb-3">Sauvegarde / Restauration</h5>
  <div class="d-flex flex-wrap gap-2 align-items-center">
    <a href="/admin/backup" class="btn btn-success btn-sm">Telecharger sauvegarde (.zip)</a>
    <form action="/admin/restore" method="POST" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
      {{ csrf_field() }}
      <input type="file" name="backup_zip" class="form-control form-control-sm" accept=".zip" required>
      <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Restaurer ecrase la base et les fichiers. Continuer ?')">Restaurer</button>
    </form>
  </div>
</div>

<div class="app-card p-3 mb-4">
  <h5 class="mb-3">Annees scolaires</h5>
  <form action="{{ url_for('admin.admin_add_school_year') }}" method="POST" class="row g-2 align-items-end mb-3">
    {{ csrf_field() }}
    <div class="col-12 col-md-4">
      <label class="small text-muted">Nouvelle annee</label>
      <input type="text" name="label" class="form-control form-control-sm" placeholder="2026/2027" required>
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button type="submit" class="btn btn-primary btn-sm">Ajouter</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Annee</th>
          <th>Etat</th>
          <th class="text-end">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for sy in school_years %}
        <tr>
          <td class="fw-bold">{{ sy.label }}</td>
          <td>
            {% if sy.is_active %}
            <span class="badge bg-success">Active</span>
            {% else %}
            <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if not sy.is_active %}
            <form action="{{ url_for('admin.admin_activate_school_year', year_id=sy.id) }}" method="POST" style="display:inline;">
              {{ csrf_field() }}
              <button type="submit" class="btn btn-outline-success btn-sm">Activer</button>
            </form>
            {% else %}
            <span class="text-muted small">Courante</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="3" class="text-center text-muted">Aucune annee.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="app-card p-3 mb-4">
  <h5 class="mb-3">Affectations enseignants</h5>
  <form action="{{ url_for('admin.admin_add_assignment') }}" method="POST" class="row g-2 align-items-end mb-3">
    {{ csrf_field() }}
    <div class="col-12 col-md-4">
      <label class="small text-muted">Enseignant / Matiere</label>
      <select name="teacher_subject" class="form-select form-select-sm" required>
        <option value="">Choisir...</option>
        {% for ts in teacher_subjects %}
        <option value="{{ ts.user_id }}|{{ ts.subject_id }}">
          {{ ts.nom_affichage }} ({{ ts.username }}) - {{ ts.subject_name }}
        </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="small text-muted">Annee scolaire</label>
      <select name="school_year" class="form-select form-select-sm" required>
        {% for sy in school_years %}
        <option value="{{ sy.label }}" {% if sy.label == active_school_year %}selected{% endif %}>{{ sy.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-3">
      <label class="small text-muted">Classe</label>
      <input type="text" name="class_name" class="form-control form-control-sm" list="classes_admin_list" placeholder="Ex: 2M2" required>
      <datalist id="classes_admin_list">
        {% for c in available_classes %}
        <option value="{{ c }}">
        {% endfor %}
      </datalist>
    </div>
    <div class="col-12 col-md-2 d-grid">
      <button type="submit" class="btn btn-primary btn-sm">Affecter</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Annee</th>
          <th>Enseignant</th>
          <th>Matiere</th>
          <th>Classe</th>
          <th class="text-end">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for a in assignments %}
        <tr>
          <td>{{ a.school_year }}</td>
          <td>{{ a.nom_affichage }} <span class="text-muted small">({{ a.username }})</span></td>
          <td>{{ a.subject_name }}</td>
          <td><span class="badge bg-secondary">{{ a.class_name }}</span></td>
          <td class="text-end">
            <form action="{{ url_for('admin.admin_delete_assignment', assignment_id=a.id) }}" method="POST" style="display:inline;">
              {{ csrf_field() }}
              <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Supprimer cette affectation ?')">Supprimer</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center text-muted">Aucune affectation.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="app-card p-3 mb-4">
  <h5 class="mb-3">Ajouter utilisateur</h5>
  <form action="/admin/create_user" method="POST" class="row g-2 align-items-end">
    {{ csrf_field() }}
    <div class="col-12 col-md-2">
      <label class="small text-muted">Username</label>
      <input type="text" name="username" class="form-control form-control-sm" required>
    </div>
    <div class="col-12 col-md-2">
      <label class="small text-muted">Nom affiche</label>
      <input type="text" name="display_name" class="form-control form-control-sm" required>
    </div>
    <div class="col-12 col-md-2">
      <label class="small text-muted">Etablissement</label>
      <input type="text" name="school_name" class="form-control form-control-sm" required>
    </div>
    <div class="col-12 col-md-2">
      <label class="small text-muted">Matiere</label>
      <input type="text" name="subject_name" class="form-control form-control-sm" required>
    </div>
    <div class="col-12 col-md-2">
      <label class="small text-muted">Mot de passe</label>
      <input type="password" name="password" class="form-control form-control-sm" required>
    </div>
    <div class="col-6 col-md-1">
      <label class="small text-muted">Role</label>
      <select name="role" class="form-select form-select-sm">
        <option value="prof" selected>Prof</option>
        <option value="read_only">Lecture seule</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div class="col-6 col-md-1 d-grid">
      <button type="submit" class="btn btn-primary btn-sm">Ajouter</button>
    </div>
  </form>
</div>

<div class="app-card p-3 mb-4">
  <h5 class="mb-3">Utilisateurs</h5>
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Nom affiche</th>
          <th>Role</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.id }}</td>
          <td class="fw-bold">{{ user.username }}</td>
          <td>{{ user.nom_affichage }}</td>
          <td>
            {% if user.role == 'admin' %}
            <span class="badge bg-danger">Admin</span>
            {% elif user.role == 'read_only' %}
            <span class="badge bg-secondary">Lecture seule</span>
            {% else %}
            <span class="badge bg-primary">Prof</span>
            {% endif %}
          </td>
          <td class="text-end">
            {% if user.id != session.get('user_id') %}
            <a href="{{ url_for('admin.admin_voir_eleves', user_id=user.id, school_year=active_school_year) }}" class="btn btn-info btn-sm text-white">Voir classe</a>

            {% if user.role != 'admin' %}
            <form action="/admin/reset_password/{{ user.id }}" method="POST" style="display:inline;">
              {{ csrf_field() }}
              <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('Generer un mot de passe temporaire ?')">Reset mdp</button>
            </form>
            {% endif %}

            <form action="/admin/reset_link/{{ user.id }}" method="POST" style="display:inline;">
              {{ csrf_field() }}
              <button type="submit" class="btn btn-outline-secondary btn-sm">Lien reset</button>
            </form>

            <form action="/admin/set_role/{{ user.id }}" method="POST" style="display:inline;" class="ms-1">
              {{ csrf_field() }}
              <select name="role" class="form-select form-select-sm d-inline-block" style="width: 145px;">
                <option value="prof" {% if user.role == 'prof' %}selected{% endif %}>Prof</option>
                <option value="read_only" {% if user.role == 'read_only' %}selected{% endif %}>Lecture seule</option>
                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
              </select>
              <button type="submit" class="btn btn-outline-primary btn-sm">Appliquer role</button>
            </form>

            {% if user.role != 'admin' %}
            <form action="/admin/delete_user/{{ user.id }}" method="POST" style="display:inline;">
              {{ csrf_field() }}
              <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Supprimer ce compte et ses donnees ?')">Supprimer</button>
            </form>
            {% endif %}
            {% else %}
            <span class="text-muted">Compte courant</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="app-card p-3 mb-4">
  <h5 class="mb-3">Documents serveur</h5>
  <div class="table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead>
        <tr>
          <th>Professeur</th>
          <th>Titre</th>
          <th>Fichier</th>
          <th class="text-end">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for doc in all_docs %}
        <tr>
          <td>{{ doc.nom_affichage }}</td>
          <td>{{ doc.titre }} <span class="badge bg-secondary">{{ doc.type_doc }}</span></td>
          <td>{{ doc.filename }}</td>
          <td class="text-end">
            <a href="/static/uploads/{{ doc.filename }}" class="btn btn-sm btn-outline-primary" target="_blank">Voir</a>
            <form action="/admin/delete_document/{{ doc.id }}" method="POST" style="display:inline;">
              {{ csrf_field() }}
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Supprimer ce document ?')">Supprimer</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="text-center text-muted">Aucun fichier.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
