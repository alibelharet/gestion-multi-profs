{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    .stat-card h3 {
        margin: 0;
    }

    .table-responsive {
        overflow-x: auto;
        background: var(--surface);
        border-radius: 12px;
        border: 1px solid var(--border);
    }

    .input-note {
        min-width: 55px;
        font-weight: bold;
        background-color: var(--bg-soft) !important;
        border: 1px solid var(--border) !important;
        color: var(--text) !important;
        text-align: center;
        border-radius: 8px;
        height: 35px;
    }

    .hero-card {
        background: linear-gradient(135deg, rgba(47, 123, 255, 0.25), rgba(48, 210, 179, 0.18));
        border: 1px solid var(--border);
        border-radius: 16px;
    }

    .meta-badge {
        background: var(--surface-2);
        border: 1px solid var(--border);
        color: var(--text);
    }

    .filter-actions .btn {
        min-width: 36px;
    }
</style>

<div class="app-card hero-card mb-4 p-3 animate-fade-up" style="animation-delay: 0.1s;">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
            <div class="text-uppercase small text-muted">Dashboard</div>
            <h2 class="fw-bold mb-1">Bienvenue, {{ nom_prof }}</h2>
            <div class="text-muted small">Suivi des notes et statistiques par matiere</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            {% if school_name %}
            <span class="badge meta-badge px-3 py-2">{{ school_name }}</span>
            {% endif %}
            <span class="badge meta-badge px-3 py-2">Annee {{ school_year }}</span>
            <span class="badge meta-badge px-3 py-2">T{{ trimestre }}</span>
            <span class="badge meta-badge px-3 py-2">{{ subject_name }}</span>
        </div>
    </div>
</div>





{% if not can_edit %}
<div class="alert alert-warning py-2">
    Mode lecture seule actif: les modifications (ajout, import, suppression, sauvegarde) sont bloquees.
</div>
{% endif %}

<div class="app-card mb-4 filters-sticky glass-panel animate-fade-up" style="animation-delay: 0.5s;">
    <div class="card-body py-3 px-3">
        <form action="/" method="get">
            <div class="row g-2 align-items-end">
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Trimestre</label>
                    <select name="trimestre" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="1" {% if trimestre=='1' %}selected{% endif %}>T1</option>
                        <option value="2" {% if trimestre=='2' %}selected{% endif %}>T2</option>
                        <option value="3" {% if trimestre=='3' %}selected{% endif %}>T3</option>
                    </select>
                </div>
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Annee</label>
                    {% if session.get('is_admin') %}
                    <select name="school_year" class="form-select form-select-sm" onchange="this.form.submit()">
                        {% for sy in school_years %}
                        <option value="{{ sy.label }}" {% if school_year==sy.label %}selected{% endif %}>
                            {{ sy.label }}{% if sy.is_active %} (active){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    {% else %}
                    <input type="text" class="form-control form-control-sm" value="{{ school_year }}" readonly>
                    <input type="hidden" name="school_year" value="{{ school_year }}">
                    {% endif %}
                </div>
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Classe</label>
                    <select name="niveau" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="all">Tous</option>
                        {% for classe in liste_classes %}<option value="{{ classe }}" {% if niveau_actuel==classe
                            %}selected{% endif %}>{{ classe }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Matiere</label>
                    {% if session.get('lock_subject') %}
                    <input type="text" class="form-control form-control-sm" value="{{ subject_name }}" readonly>
                    <input type="hidden" name="subject" value="{{ subject_id }}">
                    {% else %}
                    <select name="subject" class="form-select form-select-sm" onchange="this.form.submit()">
                        {% for s in subjects %}
                        <option value="{{ s.id }}" {% if subject_id==s.id %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                <div class="col-12 col-lg-4">
                    <label class="small text-muted">Recherche</label>
                    <input type="text" name="recherche" value="{{ recherche_actuelle }}"
                        class="form-control form-control-sm" placeholder="Rechercher..." />
                </div>
                <div class="col-12 col-lg-2 d-flex gap-1 justify-content-end filter-actions">
                    <button type="submit" class="btn btn-sm btn-outline-info"><i class="bi bi-search"></i></button>
                    {% if can_edit %}
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal"
                        data-bs-target="#addStudentModal"><i class="bi bi-person-plus-fill"></i></button>
                    <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse"
                        data-bs-target="#importBox"><i class="bi bi-file-earmark-spreadsheet-fill"></i></button>
                    {% endif %}
                </div>
            </div>

            <div class="row g-2 align-items-end mt-2">
                <div class="col-12 col-md-4">
                    <label class="small text-muted">Tri</label>
                    <select name="sort" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="class" {% if sort=='class' %}selected{% endif %}>Classe</option>
                        <option value="name" {% if sort=='name' %}selected{% endif %}>Nom</option>
                        <option value="moy" {% if sort=='moy' %}selected{% endif %}>Moyenne</option>
                        <option value="id" {% if sort=='id' %}selected{% endif %}>ID</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Ordre</label>
                    <select name="order" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="asc" {% if order=='asc' %}selected{% endif %}>Asc</option>
                        <option value="desc" {% if order=='desc' %}selected{% endif %}>Desc</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Par page</label>
                    <select name="per_page" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="25" {% if per_page==25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page==50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page==100 %}selected{% endif %}>100</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="small text-muted">Etat</label>
                    <select name="etat" class="form-select form-select-sm" onchange="this.form.submit()">
                        <option value="all" {% if etat=='all' %}selected{% endif %}>Tous</option>
                        <option value="admis" {% if etat=='admis' %}selected{% endif %}>Admis (>=10)</option>
                        <option value="echec" {% if etat=='echec' %}selected{% endif %}>Echec (&lt;10)</option>
                        <option value="non_saisi" {% if etat=='non_saisi' %}selected{% endif %}>Non saisi</option>
                    </select>
                </div>
            </div>

            <div class="row g-2 align-items-end mt-2">
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Min moy</label>
                    <input type="number" step="0.01" name="min_moy" value="{{ min_moy if min_moy is not none else '' }}"
                        class="form-control form-control-sm" onchange="this.form.submit()">
                </div>
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Max moy</label>
                    <input type="number" step="0.01" name="max_moy" value="{{ max_moy if max_moy is not none else '' }}"
                        class="form-control form-control-sm" onchange="this.form.submit()">
                </div>
                <div class="col-12 col-md-8 d-flex justify-content-end">
                    <div class="text-muted small mt-2 mt-md-0">Total: {{ total }}</div>
                </div>
            </div>
        </form>
    </div>
    {% if can_edit %}
    <div class="collapse" id="importBox">
        <div class="card-footer app-card-header p-3">
            <form action="{{ url_for('imports.import_excel') }}" method="post" enctype="multipart/form-data"
                class="d-flex gap-2 align-items-center">
                {{ csrf_field() }}
                <input class="form-control form-control-sm" type="file" name="fichier_excel" accept=".xlsx, .xls"
                    required>
                <input type="hidden" name="trimestre_import" value="{{ trimestre }}">
                <input type="hidden" name="subject" value="{{ subject_id }}">
                <input type="hidden" name="school_year" value="{{ school_year }}">
                <button type="submit" class="btn btn-sm btn-success">Importer (avec correspondance)</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<form action="{{ url_for('grades.sauvegarder_tout') }}" method="POST" id="formSaveAll">
    {{ csrf_field() }}
    <input type="hidden" name="trimestre_save" value="{{ trimestre }}">
    <input type="hidden" name="subject" value="{{ subject_id }}">
    <input type="hidden" name="school_year" value="{{ school_year }}">
    <div class="app-card animate-fade-up" style="animation-delay: 0.6s;">
        <div
            class="card-header app-card-header d-flex justify-content-between align-items-center py-2 px-3 rounded-top">
            <div>
                <h6 class="mb-0 text-body">Liste eleves</h6>
                <div class="small text-muted">Activite = Participation(3) + Comportement(6) + Cahier(5) + Projet(4) +
                    Abs/Outils(2)</div>
            </div>
            <div class="d-flex gap-1">
                {% if can_edit %}
                <button type="submit" class="btn btn-sm btn-primary px-3">Sauver</button>
                <button type="button" class="btn btn-sm btn-warning text-dark px-3" data-bs-toggle="modal"
                    data-bs-target="#fillOfficialModal">Remplir officiel</button>
                {% else %}
                <span class="badge bg-secondary align-self-center px-3 py-2">Lecture seule</span>
                {% endif %}
                <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle px-2" type="button"
                        data-bs-toggle="dropdown">Actions</button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow">
                        <li><a class="dropdown-item"
                                href="{{ url_for('reports.export_list_pdf', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, school_year=school_year) }}">Exporter
                                PDF (Liste)</a></li>
                        <li><a class="dropdown-item"
                                href="{{ url_for('reports.export_excel', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, school_year=school_year) }}">Exporter
                                Excel</a></li>
                        <li><a class="dropdown-item"
                                href="{{ url_for('reports.export_parents', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, school_year=school_year) }}">Export
                                Parents</a></li>
                        <li><a class="dropdown-item" href="#" onclick="printStudentList(); return false;"><i
                                    class="bi bi-printer"></i> Imprimer liste (sans notes)</a></li>
                        {% if can_edit %}
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="submitDelete()">Supprimer
                                selection</a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" style="min-width: 600px;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border); background-color: var(--surface-2);">
                        <th class="text-center p-2" style="width: 80px;">
                            {% if can_edit %}
                            <input type="checkbox" class="form-check-input" onclick="toggle(this)"
                                title="Tout selectionner">
                            {% else %}
                            Bulletin
                            {% endif %}
                        </th>
                        <th class="text-body p-2">#</th>
                        <th class="text-body p-2" style="min-width: 160px;">Nom</th>
                        <th class="text-center text-muted p-2">Participation (3)</th>
                        <th class="text-center text-muted p-2">Comportement (6)</th>
                        <th class="text-center text-muted p-2">Cahier (5)</th>
                        <th class="text-center text-muted p-2">Projet (4)</th>
                        <th class="text-center text-muted p-2">Abs/Outils (2)</th>
                        <th class="text-center text-info p-2">Activite /20</th>
                        <th class="text-center text-muted p-2">Devoir</th>
                        <th class="text-center text-muted p-2">Compo</th>
                        <th class="text-center text-primary p-2">Moyenne</th>
                        <th class="text-muted p-2" style="min-width: 150px;">Remarques</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in eleves %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td class="text-center d-flex gap-2 justify-content-center pt-3">
                            {% if can_edit %}
                            <input type="checkbox" name="ids_delete" value="{{ eleve.id }}"
                                class="form-check-input check-delete">
                            {% endif %}
                            <input type="hidden" name="id_eleve" value="{{ eleve.id }}">
                            <a href="{{ url_for('reports.bulletin', id=eleve.id, trimestre=trimestre, subject=subject_id, school_year=school_year) }}"
                                target="_blank" class="btn btn-sm btn-outline-info py-0 px-1" title="Imprimer Bulletin"
                                style="height: 25px;"><i class="bi bi-file-text"></i></a>
                        </td>
                        <td class="text-body fw-bold">{{ ((page - 1) * per_page) + loop.index }}</td>
                        <td class="fw-bold text-body">{{ eleve.nom_complet }}<br><span
                                class="badge bg-secondary text-body border border-dark mt-1"
                                style="font-size: 0.65em;">{{ eleve.niveau }}</span></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="3" id="part_{{eleve.id}}"
                                name="participation" value="{{ eleve.participation }}" class="form-control input-note"
                                oninput="calculLive({{eleve.id}})" {% if not can_edit %}readonly{% endif %}></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="6" id="comport_{{eleve.id}}"
                                name="comportement" value="{{ eleve.comportement }}" class="form-control input-note"
                                oninput="calculLive({{eleve.id}})" {% if not can_edit %}readonly{% endif %}></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="5" id="cah_{{eleve.id}}"
                                name="cahier" value="{{ eleve.cahier }}" class="form-control input-note"
                                oninput="calculLive({{eleve.id}})" {% if not can_edit %}readonly{% endif %}></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="4" id="proj_{{eleve.id}}"
                                name="projet" value="{{ eleve.projet }}" class="form-control input-note"
                                oninput="calculLive({{eleve.id}})" {% if not can_edit %}readonly{% endif %}></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="2" id="ao_{{eleve.id}}"
                                name="assiduite_outils" value="{{ eleve.assiduite_outils }}"
                                class="form-control input-note" oninput="calculLive({{eleve.id}})" {% if not can_edit
                                %}readonly{% endif %}></td>
                        <td class="text-center fw-bold fs-6 text-info"><span id="act_display_{{eleve.id}}">{{
                                eleve.activite }}</span><input type="hidden" id="act_{{eleve.id}}" name="activite"
                                value="{{ eleve.activite }}"></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="20" id="dev_{{eleve.id}}"
                                name="devoir" value="{{ eleve.devoir }}" class="form-control input-note"
                                oninput="calculLive({{eleve.id}})" {% if not can_edit %}readonly{% endif %}></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="20" id="comp_{{eleve.id}}"
                                name="compo" value="{{ eleve.compo }}" class="form-control input-note"
                                oninput="calculLive({{eleve.id}})" {% if not can_edit %}readonly{% endif %}></td>
                        <td class="text-center fw-bold fs-5"><span id="moy_{{eleve.id}}"
                                class="{% if eleve.moyenne < 10 %}text-danger{% else %}text-success{% endif %}">{{
                                eleve.moyenne }}</span></td>
                        <td class="small text-muted text-truncate" style="max-width: 150px;">{{ eleve.remarques }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="13" class="text-center py-5 text-body">Aucun resultat.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if pages > 1 %}
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 py-2 px-2 app-card-header">
            <div class="text-muted small">Page {{ page }} / {{ pages }} • {{ total }} eleves</div>
            <nav aria-label="Pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link"
                            href="{{ url_for('dashboard.index', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, per_page=per_page, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, school_year=school_year, page=page-1) }}">«</a>
                    </li>

                    {% set start = 1 if page - 2 < 1 else page - 2 %} {% set end=pages if page + 2> pages else page + 2
                        %}
                        {% for p in range(start, end + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link"
                                href="{{ url_for('dashboard.index', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, per_page=per_page, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, school_year=school_year, page=p) }}">{{
                                p }}</a>
                        </li>
                        {% endfor %}

                        <li class="page-item {% if page >= pages %}disabled{% endif %}">
                            <a class="page-link"
                                href="{{ url_for('dashboard.index', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, per_page=per_page, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, school_year=school_year, page=page+1) }}">»</a>
                        </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</form>

{% if can_edit %}
<form action="{{ url_for('students.supprimer_multi') }}" method="POST" id="formMultiDelete" style="display:none;">
    {{ csrf_field() }}
    <input type="hidden" name="school_year" value="{{ school_year }}">
</form>

<div class="modal fade" id="fillOfficialModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #2d2d2d; color: white;">
            <div class="modal-header border-secondary bg-warning text-dark">
                <h5 class="modal-title fw-bold">Remplir bulletin officiel</h5><button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('imports.remplir_bulletin_officiel') }}" method="POST"
                enctype="multipart/form-data">
                {{ csrf_field() }}
                <div class="modal-body text-center p-4">
                    <p class="text-muted mb-3">Importer le fichier Excel vide.</p>
                    <input type="hidden" name="trimestre_fill" value="{{ trimestre }}">
                    <input type="hidden" name="subject" value="{{ subject_id }}">
                    <input type="hidden" name="school_year" value="{{ school_year }}">
                    <input type="file" class="form-control " name="fichier_vide" accept=".xlsx" required>
                </div>
                <div class="modal-footer border-secondary justify-content-center"><button type="submit"
                        class="btn btn-warning w-75 fw-bold">Remplir et telecharger</button></div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #2d2d2d; color: white;">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-success">Ajouter eleve</h5><button type="button"
                    class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('students.ajouter_eleve') }}" method="POST">
                {{ csrf_field() }}
                <div class="modal-body p-4">
                    <input type="hidden" name="trimestre_ajout" value="{{ trimestre }}">
                    <input type="hidden" name="subject" value="{{ subject_id }}">
                    <input type="hidden" name="school_year" value="{{ school_year }}">
                    <div class="mb-3"><label class="form-label small text-muted">Nom complet</label><input type="text"
                            class="form-control " name="nom_complet" placeholder="Ex: Benali Mohamed" required></div>
                    <div class="mb-3"><label class="form-label small text-muted">Classe</label><input type="text"
                            class="form-control " name="niveau" placeholder="Ex: 4M2" required
                            list="classes_list"><datalist id="classes_list">{% for classe in liste_classes %}<option
                                value="{{ classe }}">{% endfor %}</datalist></div>
                    <div class="row g-2">
                        <div class="col-6"><input type="text" class="form-control " name="parent_phone"
                                placeholder="Tel parent"></div>
                        <div class="col-6"><input type="email" class="form-control " name="parent_email"
                                placeholder="Email parent"></div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-4"><input type="number" step="0.01" min="0" max="3"
                                class="form-control  text-center activite-part" name="participation"
                                placeholder="Participation (3)" oninput="calculAddActivite()"></div>
                        <div class="col-4"><input type="number" step="0.01" min="0" max="6"
                                class="form-control  text-center activite-part" name="comportement"
                                placeholder="Comportement (6)" oninput="calculAddActivite()"></div>
                        <div class="col-4"><input type="number" step="0.01" min="0" max="5"
                                class="form-control  text-center activite-part" name="cahier" placeholder="Cahier (5)"
                                oninput="calculAddActivite()"></div>
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-4"><input type="number" step="0.01" min="0" max="4"
                                class="form-control  text-center activite-part" name="projet" placeholder="Projet (4)"
                                oninput="calculAddActivite()"></div>
                        <div class="col-4"><input type="number" step="0.01" min="0" max="2"
                                class="form-control  text-center activite-part" name="assiduite_outils"
                                placeholder="Abs/Outils (2)" oninput="calculAddActivite()"></div>
                        <div class="col-4"><input type="text" id="activite_total_add" class="form-control text-center"
                                value="Activite: 0.00 / 20" readonly></div>
                        <input type="hidden" id="activite_hidden_add" name="activite" value="0">
                    </div>
                    <div class="row g-2 mt-2">
                        <div class="col-6"><input type="number" step="0.01" class="form-control  text-center"
                                name="devoir" placeholder="Dev"></div>
                        <div class="col-6"><input type="number" step="0.01" class="form-control  text-center"
                                name="compo" placeholder="Ex"></div>
                    </div>
                </div>
                <div class="modal-footer border-secondary justify-content-center"><button type="submit"
                        class="btn btn-success w-75 fw-bold">Sauver</button></div>
            </form>
        </div>
    </div>
</div>


<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<script>
    function printStudentList() {
        const rows = document.querySelectorAll('#formSaveAll tbody tr');
        if (!rows.length) { alert('Aucun eleve a imprimer.'); return; }
        let html = '<tr><th>#</th><th>Nom complet</th><th>Classe</th><th>Devoir</th><th>Activite</th><th>Compo</th><th>Moyenne</th><th>Remarques</th></tr>';
        let i = 1;
        rows.forEach(tr => {
            const cells = tr.querySelectorAll('td');
            if (cells.length < 3) return;
            const nom = cells[2].querySelector('.fw-bold')?.childNodes[0]?.textContent?.trim() || cells[2].textContent.trim().split('\n')[0];
            const classe = cells[2].querySelector('.badge')?.textContent?.trim() || '';
            html += '<tr><td>' + i + '</td><td>' + nom + '</td><td>' + classe + '</td><td></td><td></td><td></td><td></td><td></td></tr>';
            i++;
        });
        const w = window.open('', '_blank');
        w.document.write('<!DOCTYPE html><html><head><title>Liste des eleves</title>');
        w.document.write('<style>');
        w.document.write('body{font-family:Arial,sans-serif;margin:20px;direction:ltr}');
        w.document.write('h2{text-align:center;margin-bottom:5px}');
        w.document.write('.meta{text-align:center;color:#666;margin-bottom:15px;font-size:13px}');
        w.document.write('table{width:100%;border-collapse:collapse}');
        w.document.write('th,td{border:1px solid #333;padding:6px 8px;font-size:12px}');
        w.document.write('th{background:#eee;font-weight:bold;text-align:center}');
        w.document.write('td:first-child{text-align:center;width:30px}');
        w.document.write('td:nth-child(4),td:nth-child(5),td:nth-child(6),td:nth-child(7){text-align:center;width:60px}');
        w.document.write('td:last-child{width:100px}');
        w.document.write('@media print{body{margin:10px}}');
        w.document.write('</style></head><body>');
        w.document.write('<h2>Liste des eleves</h2>');
        w.document.write('<div class="meta">{{ subject_name }} — {{ niveau_actuel if niveau_actuel != "all" else "Toutes classes" }} — T{{ trimestre }} — {{ school_year }}</div>');
        w.document.write('<table>' + html + '</table>');
        w.document.write('</body></html>');
        w.document.close();
        setTimeout(() => w.print(), 300);
    }
</script>

{% endblock %}