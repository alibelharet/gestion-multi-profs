{% extends 'base.html' %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
    .stat-card h3 { margin: 0; }
    .table-responsive { overflow-x: auto; background: var(--surface); border-radius: 12px; border: 1px solid var(--border); }
    .input-note { min-width: 55px; font-weight: bold; background-color: var(--bg-soft) !important; border: 1px solid var(--border) !important; color: var(--text) !important; text-align: center; border-radius: 8px; height: 35px; }
    .hero-card { background: linear-gradient(135deg, rgba(47, 123, 255, 0.25), rgba(48, 210, 179, 0.18)); border: 1px solid var(--border); border-radius: 16px; }
    .meta-badge { background: var(--surface-2); border: 1px solid var(--border); color: var(--text); }
    .filter-actions .btn { min-width: 36px; }
</style>

<div class="app-card hero-card mb-4 p-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
            <div class="text-uppercase small text-muted">Dashboard</div>
            <h2 class="fw-bold mb-1">Bienvenue, {{ nom_prof }}</h2>
            <div class="text-muted small">Suivi des notes et statistiques par matiere</div>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <span class="badge meta-badge px-3 py-2">Annee {{ school_year }}</span>
            <span class="badge meta-badge px-3 py-2">T{{ trimestre }}</span>
            <span class="badge meta-badge px-3 py-2">{{ subject_name }}</span>
        </div>
    </div>
</div>

{% if eleves %}
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="stat-card p-3 h-100">
            <div class="text-muted small">Moyenne generale</div>
            <h3 class="fw-bold text-body">{{ stats.moyenne_generale }}</h3>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card p-3 h-100">
            <div class="text-muted small">Taux reussite</div>
            <h3 class="fw-bold text-success">{{ stats.taux_reussite }}%</h3>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card p-3 h-100">
            <div class="text-muted small">Admis</div>
            <h3 class="fw-bold text-body">{{ stats.nb_admis }} / {{ stats.nb_total }}</h3>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="stat-card p-3 h-100">
            <div class="text-muted small">Max / Min</div>
            <h3 class="fw-bold text-body">{{ stats.meilleure_note }} / {{ stats.pire_note }}</h3>
        </div>
    </div>
</div>
{% endif %}

{% if eleves %}
<div class="app-card mb-4">
    <div class="card-header app-card-header d-flex justify-content-between align-items-center py-2 px-3 rounded-top">
        <h6 class="mb-0 text-body">Statistiques avancees</h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-12 col-lg-6">
                <div class="text-muted small mb-2">Moyenne par classe</div>
                <canvas id="chartClasses" height="180"></canvas>
            </div>
            <div class="col-12 col-lg-6">
                <div class="text-muted small mb-2">Repartition</div>
                <canvas id="chartDist" height="180"></canvas>
            </div>
        </div>

        <div class="table-responsive mt-4">
            <table class="table table-sm mb-0 align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nom</th>
                        <th>Classe</th>
                        <th>Moyenne</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in top_eleves %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ e.nom }}</td>
                        <td>{{ e.niveau }}</td>
                        <td class="fw-bold">{{ e.moyenne }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="4" class="text-center text-muted py-3">Aucun resultat</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="app-card mb-4 filters-sticky glass-panel">
    <div class="card-body py-3 px-3">
        <form action="/" method="get">
            <div class="row g-2 align-items-end">
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Trimestre</label>
                    <select name="trimestre" class="form-select form-select-sm " onchange="this.form.submit()">
                        <option value="1" {% if trimestre == '1' %}selected{% endif %}>T1</option>
                        <option value="2" {% if trimestre == '2' %}selected{% endif %}>T2</option>
                        <option value="3" {% if trimestre == '3' %}selected{% endif %}>T3</option>
                    </select>
                </div>
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Classe</label>
                    <select name="niveau" class="form-select form-select-sm " onchange="this.form.submit()">
                        <option value="all">Tous</option>
                        {% for classe in liste_classes %}<option value="{{ classe }}" {% if niveau_actuel == classe %}selected{% endif %}>{{ classe }}</option>{% endfor %}
                    </select>
                </div>
                <div class="col-6 col-lg-2">
                    <label class="small text-muted">Matiere</label>
                    <select name="subject" class="form-select form-select-sm " onchange="this.form.submit()">
                        {% for s in subjects %}
                        <option value="{{ s.id }}" {% if subject_id == s.id %}selected{% endif %}>{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-lg-4">
                    <label class="small text-muted">Recherche</label>
                    <input type="text" name="recherche" value="{{ recherche_actuelle }}" class="form-control form-control-sm " placeholder="Rechercher..." />
                </div>
                <div class="col-12 col-lg-2 d-flex gap-1 justify-content-end filter-actions">
                    <button type="submit" class="btn btn-sm btn-outline-info"><i class="bi bi-search"></i></button>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addStudentModal"><i class="bi bi-person-plus-fill"></i></button>
                    <button class="btn btn-sm btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#importBox"><i class="bi bi-file-earmark-spreadsheet-fill"></i></button>
                </div>
            </div>

            <div class="row g-2 align-items-end mt-2">
                <div class="col-12 col-md-4">
                    <label class="small text-muted">Tri</label>
                    <select name="sort" class="form-select form-select-sm " onchange="this.form.submit()">
                        <option value="class" {% if sort == 'class' %}selected{% endif %}>Classe</option>
                        <option value="name" {% if sort == 'name' %}selected{% endif %}>Nom</option>
                        <option value="moy" {% if sort == 'moy' %}selected{% endif %}>Moyenne</option>
                        <option value="id" {% if sort == 'id' %}selected{% endif %}>ID</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Ordre</label>
                    <select name="order" class="form-select form-select-sm " onchange="this.form.submit()">
                        <option value="asc" {% if order == 'asc' %}selected{% endif %}>Asc</option>
                        <option value="desc" {% if order == 'desc' %}selected{% endif %}>Desc</option>
                    </select>
                </div>
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Par page</label>
                    <select name="per_page" class="form-select form-select-sm " onchange="this.form.submit()">
                        <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label class="small text-muted">Etat</label>
                    <select name="etat" class="form-select form-select-sm " onchange="this.form.submit()">
                        <option value="all" {% if etat == 'all' %}selected{% endif %}>Tous</option>
                        <option value="admis" {% if etat == 'admis' %}selected{% endif %}>Admis (>=10)</option>
                        <option value="echec" {% if etat == 'echec' %}selected{% endif %}>Echec (<10)</option>
                        <option value="non_saisi" {% if etat == 'non_saisi' %}selected{% endif %}>Non saisi</option>
                    </select>
                </div>
            </div>

            <div class="row g-2 align-items-end mt-2">
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Min moy</label>
                    <input type="number" step="0.01" name="min_moy" value="{{ min_moy if min_moy is not none else '' }}" class="form-control form-control-sm " onchange="this.form.submit()">
                </div>
                <div class="col-6 col-md-2">
                    <label class="small text-muted">Max moy</label>
                    <input type="number" step="0.01" name="max_moy" value="{{ max_moy if max_moy is not none else '' }}" class="form-control form-control-sm " onchange="this.form.submit()">
                </div>
                <div class="col-12 col-md-8 d-flex justify-content-end">
                    <div class="text-muted small mt-2 mt-md-0">Total: {{ total }}</div>
                </div>
            </div>
        </form>
    </div>
    <div class="collapse" id="importBox">
        <div class="card-footer app-card-header p-3">
            <form action="/import_excel" method="post" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                {{ csrf_field() }}
                <input class="form-control form-control-sm " type="file" name="fichier_excel" accept=".xlsx, .xls" required>
                <input type="hidden" name="trimestre_import" value="{{ trimestre }}">
                <input type="hidden" name="subject" value="{{ subject_id }}">
                <button type="submit" class="btn btn-sm btn-success">Import</button>
            </form>
        </div>
    </div>
</div>

<form action="/sauvegarder_tout" method="POST" id="formSaveAll">
    {{ csrf_field() }}
    <input type="hidden" name="trimestre_save" value="{{ trimestre }}">
    <input type="hidden" name="subject" value="{{ subject_id }}">
    <div class="app-card">
        <div class="card-header app-card-header d-flex justify-content-between align-items-center py-2 px-3 rounded-top">
            <h6 class="mb-0 text-body">Liste eleves</h6>
            <div class="d-flex gap-1">
                <button type="submit" class="btn btn-sm btn-primary px-3">Sauver</button>
                <button type="button" class="btn btn-sm btn-warning text-dark px-3" data-bs-toggle="modal" data-bs-target="#fillOfficialModal">Remplir officiel</button>
                <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle px-2" type="button" data-bs-toggle="dropdown">Actions</button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow">
                        <li><a class="dropdown-item" href="{{ url_for('main.print_list', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id) }}" target="_blank">Imprimer HTML</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.export_list_pdf', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id) }}">Exporter PDF (Liste)</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.export_excel', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id) }}">Exporter Excel</a></li>
                        <li><a class="dropdown-item" href="{{ url_for('main.export_parents', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id) }}">Export Parents</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="submitDelete()">Supprimer selection</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover mb-0 align-middle" style="min-width: 600px;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--border); background-color: var(--surface-2);">
                        <th class="text-center p-2" style="width: 80px;"><input type="checkbox" class="form-check-input" onclick="toggle(this)" title="Tout selectionner"></th>
                        <th class="text-body p-2">#</th>
                        <th class="text-body p-2" style="min-width: 160px;">Nom</th>
                        <th class="text-center text-muted p-2">Activite</th>
                        <th class="text-center text-muted p-2">Devoir</th>
                        <th class="text-center text-muted p-2">Compo</th>
                        <th class="text-center text-primary p-2">Moyenne</th>
                        <th class="text-muted p-2" style="min-width: 150px;">Remarques</th>
                    </tr>
                </thead>
                <tbody>
                    {% for eleve in eleves %}
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td class="text-center d-flex gap-2 justify-content-center pt-3">
                            <input type="checkbox" name="ids_delete" value="{{ eleve.id }}" class="form-check-input check-delete">
                            <input type="hidden" name="id_eleve" value="{{ eleve.id }}">
                            <a href="/bulletin/{{ eleve.id }}?trimestre={{ trimestre }}&subject={{ subject_id }}" target="_blank" class="btn btn-sm btn-outline-info py-0 px-1" title="Imprimer Bulletin" style="height: 25px;"><i class="bi bi-file-text"></i></a>
                        </td>
                        <td class="text-body fw-bold">{{ ((page - 1) * per_page) + loop.index }}</td>
                        <td class="fw-bold text-body">{{ eleve.nom_complet }}<br><span class="badge bg-secondary text-body border border-dark mt-1" style="font-size: 0.65em;">{{ eleve.niveau }}</span></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="20" id="act_{{eleve.id}}" name="activite" value="{{ eleve.activite }}" class="form-control input-note" oninput="calculLive({{eleve.id}})"></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="20" id="dev_{{eleve.id}}" name="devoir" value="{{ eleve.devoir }}" class="form-control input-note" oninput="calculLive({{eleve.id}})"></td>
                        <td class="p-1"><input type="number" step="0.01" min="0" max="20" id="comp_{{eleve.id}}" name="compo" value="{{ eleve.compo }}" class="form-control input-note" oninput="calculLive({{eleve.id}})"></td>
                        <td class="text-center fw-bold fs-5"><span id="moy_{{eleve.id}}" class="{% if eleve.moyenne < 10 %}text-danger{% else %}text-success{% endif %}">{{ eleve.moyenne }}</span></td>
                        <td class="small text-muted text-truncate" style="max-width: 150px;">{{ eleve.remarques }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="9" class="text-center py-5 text-body">Aucun resultat.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if pages > 1 %}
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 py-2 px-2 app-card-header">
            <div class="text-muted small">Page {{ page }} / {{ pages }} • {{ total }} eleves</div>
            <nav aria-label="Pagination">
                <ul class="pagination pagination-sm mb-0">
                    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('main.index', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, per_page=per_page, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, page=page-1) }}">«</a>
                    </li>

                    {% set start = 1 if page - 2 < 1 else page - 2 %}
                    {% set end = pages if page + 2 > pages else page + 2 %}
                    {% for p in range(start, end + 1) %}
                        <li class="page-item {% if p == page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.index', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, per_page=per_page, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, page=p) }}">{{ p }}</a>
                        </li>
                    {% endfor %}

                    <li class="page-item {% if page >= pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('main.index', trimestre=trimestre, niveau=niveau_actuel, recherche=recherche_actuelle, sort=sort, order=order, per_page=per_page, min_moy=min_moy, max_moy=max_moy, etat=etat, subject=subject_id, page=page+1) }}">»</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</form>

<form action="/supprimer_multi" method="POST" id="formMultiDelete" style="display:none;">
    {{ csrf_field() }}
</form>

<div class="modal fade" id="fillOfficialModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: #2d2d2d; color: white;">
      <div class="modal-header border-secondary bg-warning text-dark"><h5 class="modal-title fw-bold">Remplir bulletin officiel</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <form action="/remplir_bulletin_officiel" method="POST" enctype="multipart/form-data">
        {{ csrf_field() }}
        <div class="modal-body text-center p-4">
            <p class="text-muted mb-3">Importer le fichier Excel vide.</p>
            <input type="hidden" name="trimestre_fill" value="{{ trimestre }}">
            <input type="file" class="form-control " name="fichier_vide" accept=".xlsx" required>
        </div>
        <div class="modal-footer border-secondary justify-content-center"><button type="submit" class="btn btn-warning w-75 fw-bold">Remplir et telecharger</button></div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="addStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="background-color: #2d2d2d; color: white;">
      <div class="modal-header border-secondary"><h5 class="modal-title text-success">Ajouter eleve</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <form action="/ajouter_eleve" method="POST">
        {{ csrf_field() }}
        <div class="modal-body p-4">
            <input type="hidden" name="trimestre_ajout" value="{{ trimestre }}">
            <input type="hidden" name="subject" value="{{ subject_id }}">
            <div class="mb-3"><label class="form-label small text-muted">Nom complet</label><input type="text" class="form-control " name="nom_complet" placeholder="Ex: Benali Mohamed" required></div>
            <div class="mb-3"><label class="form-label small text-muted">Classe</label><input type="text" class="form-control " name="niveau" placeholder="Ex: 4M2" required list="classes_list"><datalist id="classes_list">{% for classe in liste_classes %}<option value="{{ classe }}">{% endfor %}</datalist></div>
            <div class="row g-2">
                <div class="col-6"><input type="text" class="form-control " name="parent_phone" placeholder="Tel parent"></div>
                <div class="col-6"><input type="email" class="form-control " name="parent_email" placeholder="Email parent"></div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-4"><input type="number" step="0.01" class="form-control  text-center" name="activite" placeholder="Act"></div>
                <div class="col-4"><input type="number" step="0.01" class="form-control  text-center" name="devoir" placeholder="Dev"></div>
                <div class="col-4"><input type="number" step="0.01" class="form-control  text-center" name="compo" placeholder="Ex"></div>
            </div>
        </div>
        <div class="modal-footer border-secondary justify-content-center"><button type="submit" class="btn btn-success w-75 fw-bold">Sauver</button></div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    {% if eleves %}
    (function() {
        const data = {{ chart_data|safe }};
        const ctxClasses = document.getElementById('chartClasses');
        const ctxDist = document.getElementById('chartDist');

        if (ctxClasses) {
            new Chart(ctxClasses, {
                type: 'bar',
                data: {
                    labels: data.classes.labels,
                    datasets: [{ label: 'Moyenne', data: data.classes.values, backgroundColor: '#0d6efd' }]
                },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 20 } } }
            });
        }

        if (ctxDist) {
            new Chart(ctxDist, {
                type: 'doughnut',
                data: { labels: data.distribution.labels, datasets: [{ data: data.distribution.values, backgroundColor: ['#198754', '#dc3545', '#6c757d'] }] },
                options: { responsive: true }
            });
        }
    })();
    {% endif %}
</script>

<script>
    function calculLive(id) {
        var actInput = document.getElementById('act_' + id); var devInput = document.getElementById('dev_' + id); var compInput = document.getElementById('comp_' + id); var moySpan = document.getElementById('moy_' + id);
        checkMax(actInput); checkMax(devInput); checkMax(compInput);
        var act = parseFloat(actInput.value) || 0; var dev = parseFloat(devInput.value) || 0; var comp = parseFloat(compInput.value) || 0;
        var moyenne = ((dev + act) / 2 + (comp * 2)) / 3;
        moySpan.innerText = moyenne.toFixed(2);
        if (moyenne < 10) { moySpan.className = 'text-danger fw-bold fs-5'; } else { moySpan.className = 'text-success fw-bold fs-5'; }
    }
    function checkMax(input) { if(input.value > 20) { input.value = 20; input.style.borderColor = 'red'; setTimeout(function(){ input.style.borderColor = '#444'; }, 500); } if(input.value < 0) { input.value = 0; } }
    function toggle(source) { checkboxes = document.querySelectorAll('.check-delete'); for(var i=0, n=checkboxes.length;i<n;i++) { checkboxes[i].checked = source.checked; } }
    function submitDelete() {
        if(!confirm('Supprimer les eleves selectionnes ?')) return;
        var formDelete = document.getElementById('formMultiDelete');
        var csrfInputExisting = formDelete.querySelector('input[name=\'csrf_token\']');
        var csrfVal = csrfInputExisting ? csrfInputExisting.value : null;
        formDelete.innerHTML = '';
        if (csrfVal) {
            var csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfVal;
            formDelete.appendChild(csrfInput);
        }
        var checkboxes = document.querySelectorAll('.check-delete:checked');
        if(checkboxes.length === 0) { alert('Selectionnez au moins un eleve'); return; }
        checkboxes.forEach(function(chk) { var input = document.createElement('input'); input.type = 'hidden'; input.name = 'ids'; input.value = chk.value; formDelete.appendChild(input); });
        formDelete.submit();
    }
</script>

{% endblock %}
