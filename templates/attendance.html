{% extends 'base.html' %}

{% block content %}
<style>
  .attendance-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; }
  .attendance-header { background: var(--surface-2); border-bottom: 1px solid var(--border); }
  .kpi { background: var(--surface-2); border: 1px solid var(--border); border-radius: 10px; }
</style>

<div class="attendance-card mb-4">
  <div class="attendance-header p-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h5 class="mb-0">Absences et retards - T{{ trimestre }}</h5>
    <span class="badge text-bg-secondary">{{ total_events }} evenements</span>
  </div>
  <div class="p-3">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-12 col-md-2">
        <label class="small text-muted">Trimestre</label>
        <select name="trimestre" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="1" {% if trimestre == '1' %}selected{% endif %}>T1</option>
          <option value="2" {% if trimestre == '2' %}selected{% endif %}>T2</option>
          <option value="3" {% if trimestre == '3' %}selected{% endif %}>T3</option>
        </select>
      </div>
      <div class="col-12 col-md-3">
        <label class="small text-muted">Classe</label>
        <select name="niveau" class="form-select form-select-sm" onchange="this.form.submit()">
          <option value="all">Toutes</option>
          {% for classe in liste_classes %}
          <option value="{{ classe }}" {% if niveau_actuel == classe %}selected{% endif %}>{{ classe }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-5">
        <label class="small text-muted">Recherche eleve</label>
        <input type="text" name="recherche" value="{{ recherche_actuelle }}" class="form-control form-control-sm" placeholder="Nom eleve">
      </div>
      <div class="col-12 col-md-2 d-grid">
        <button class="btn btn-sm btn-primary" type="submit">Filtrer</button>
      </div>
    </form>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-6 col-md-4">
    <div class="kpi p-3 text-center">
      <div class="small text-muted">Absences</div>
      <div class="fs-4 fw-bold text-danger">{{ total_absences }}</div>
    </div>
  </div>
  <div class="col-6 col-md-4">
    <div class="kpi p-3 text-center">
      <div class="small text-muted">Retards</div>
      <div class="fs-4 fw-bold text-warning">{{ total_retards }}</div>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="kpi p-3 text-center">
      <div class="small text-muted">Total</div>
      <div class="fs-4 fw-bold">{{ total_events }}</div>
    </div>
  </div>
</div>

<div class="attendance-card mb-4">
  <div class="attendance-header p-3">
    <h6 class="mb-0">Ajouter un evenement</h6>
  </div>
  <div class="p-3">
    <form method="post" class="row g-2 align-items-end">
      {{ csrf_field() }}
      <input type="hidden" name="trimestre" value="{{ trimestre }}">
      <input type="hidden" name="niveau" value="{{ niveau_actuel }}">
      <input type="hidden" name="recherche" value="{{ recherche_actuelle }}">
      <div class="col-12 col-lg-4">
        <label class="small text-muted">Eleve</label>
        <select name="eleve_id" class="form-select form-select-sm" required>
          <option value="">Selectionner</option>
          {% for s in students %}
          <option value="{{ s.id }}">{{ s.nom_complet }} ({{ s.niveau }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <label class="small text-muted">Type</label>
        <select name="event_type" class="form-select form-select-sm" required>
          <option value="absence">Absence</option>
          <option value="retard">Retard</option>
        </select>
      </div>
      <div class="col-6 col-lg-2">
        <label class="small text-muted">Date</label>
        <input type="date" name="event_date" class="form-control form-control-sm" value="{{ today }}">
      </div>
      <div class="col-6 col-lg-2">
        <label class="small text-muted">Justifie</label>
        <select name="justified" class="form-select form-select-sm">
          <option value="0" selected>Non</option>
          <option value="1">Oui</option>
        </select>
      </div>
      <div class="col-6 col-lg-2 d-grid">
        <button class="btn btn-sm btn-success" type="submit">Ajouter</button>
      </div>
      <div class="col-12">
        <label class="small text-muted">Details</label>
        <input type="text" name="details" maxlength="300" class="form-control form-control-sm" placeholder="Optionnel">
      </div>
    </form>
  </div>
</div>

<div class="attendance-card mb-4">
  <div class="attendance-header p-3">
    <h6 class="mb-0">Synthese par eleve</h6>
  </div>
  <div class="table-responsive">
    <table class="table table-sm mb-0 align-middle">
      <thead>
        <tr>
          <th>Eleve</th>
          <th>Classe</th>
          <th class="text-center">Absences</th>
          <th class="text-center">Retards</th>
          <th class="text-center">Justifies</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr>
          <td>{{ s.nom_complet }}</td>
          <td>{{ s.niveau }}</td>
          <td class="text-center text-danger fw-bold">{{ s.absences or 0 }}</td>
          <td class="text-center text-warning fw-bold">{{ s.retards or 0 }}</td>
          <td class="text-center">{{ s.justifies or 0 }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-center py-3 text-muted">Aucun eleve.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="attendance-card">
  <div class="attendance-header p-3">
    <h6 class="mb-0">Derniers evenements</h6>
  </div>
  <div class="table-responsive">
    <table class="table table-sm mb-0 align-middle">
      <thead>
        <tr>
          <th>Date</th>
          <th>Eleve</th>
          <th>Classe</th>
          <th>Type</th>
          <th>Justifie</th>
          <th>Details</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for ev in recent_events %}
        <tr>
          <td>{{ ev.event_date }}</td>
          <td>{{ ev.nom_complet }}</td>
          <td>{{ ev.niveau }}</td>
          <td>
            {% if ev.event_type == 'absence' %}
            <span class="badge text-bg-danger">Absence</span>
            {% else %}
            <span class="badge text-bg-warning">Retard</span>
            {% endif %}
          </td>
          <td>{{ 'Oui' if ev.justified else 'Non' }}</td>
          <td>{{ ev.details or '' }}</td>
          <td class="text-end">
            <form action="{{ url_for('main.attendance_delete', event_id=ev.id) }}" method="post">
              {{ csrf_field() }}
              <input type="hidden" name="trimestre" value="{{ trimestre }}">
              <input type="hidden" name="niveau" value="{{ niveau_actuel }}">
              <input type="hidden" name="recherche" value="{{ recherche_actuelle }}">
              <button class="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Supprimer cet evenement ?')">Supprimer</button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center py-3 text-muted">Aucun evenement.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
